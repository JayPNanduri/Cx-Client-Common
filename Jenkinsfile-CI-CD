#!/groovy
//@Library('cx-jenkins-pipeline-kit') _

def workingDirectory

pipeline {
/*    parameters {
        string(name: 'buildDef', defaultValue: 'CxSAST.Main.Release.Setup', description: 'Tfs build definition name')
        string(name: "TriggeredArtifactoryPath", defaultValue: '', description: "full atrifactory repository path to the new artifacts that triggerd the pipeline")
    }*/
    agent { node { label 'CxSDLC-Slave' } }
    options {
        timestamps()
        timeout(time: 1, unit: 'HOURS')
        //skipDefaultCheckout()
    }
    stages {

        stage('Pipeline Info') {
            steps {
                script {
                    sh 'printenv'
                    workingDirectory = pwd()
                }
            }
        }

        stage('Remove SNAPSHOT from POM') {
            when {
                expression { BRANCH_NAME == 'master' }
            }
            steps {
                script {
                    sh "sed -e 's/-SNAPSHOT//g' -i ./pom.xml"
                }
            }
        }

        stage('Build CxCommon') {
            steps {
                script {
                    sh "docker run --rm --name build-${BUILD_TAG} -v maven-repo:/root/.m2 -v ${workingDirectory}:/usr/src/cx-common -w /usr/src/cx-common maven:3.6.1-jdk-8-alpine mvn clean install -DskipTests"
                }
            }
        }

        stage('Run Unit & Integration Tests') {
            steps {
                script {
                    sh "docker run --rm --name build-${BUILD_TAG} -v maven-repo:/root/.m2 -v ${workingDirectory}:/usr/src/cx-common -w /usr/src/cx-common maven:3.6.1-jdk-8-alpine mvn test"
                }
            }
        }

        stage('Run Sonar') {
            steps {
                script {
                    sh "docker run --rm --name sonar-${BUILD_TAG} -v maven-repo:/root/.m2 -v ${workingDirectory}:/usr/src/cx-common -w /usr/src/cx-common maven:3.6.1-jdk-8-alpine mvn sonar:sonar"
                }
            }
        }
    }

    post {
        cleanup {
            script{
                cleanWs()
            }
        }
    }
}
